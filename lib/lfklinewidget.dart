library lfklinewidget;
import 'package:lfklinewidget/kLineParmManager.dart';

import 'kLineWidget.dart';
import 'kLinePrintController.dart';
import 'kLineColorConfig.dart';
import 'kLineTypeSwitchWidget.dart';
import 'kLineModel.dart';
import 'printCore.dart';
import 'kLineDataManager.dart';
import 'kLineParmSetWidget.dart';
import 'kLineDataManager.dart';
import 'package:flutter/material.dart';


//try by klinePage
void main() => runApp(MyApp());

class MyApp extends StatelessWidget {
  const MyApp({Key key}) : super(key: key);

@override
Widget build(BuildContext context) {
  return MaterialApp(

      debugShowCheckedModeBanner: false,
      home: KlinePage(),

  );
}
}


class KlinePage extends StatefulWidget {
  KlinePage({Key key}) : super(key: key);
  @override
  _KlinePageState createState() => _KlinePageState();
}

class _KlinePageState extends State<KlinePage> {
  String title = "上证指数";
      // static GlobalKey<_kLineWidgetState> key = GlobalKey();
      static List<KLineModel> dataList = [

      ];
      static KLineDataManager manager = KLineDataManager(dataList: dataList,parmManager: KlineParmManager(),printController: KlinePrintController());
      void _incrementCounter() {
        manager.caculateDataList();
        setState(() {

    });
  }

  Future<String> getDataList()async{
    dataList.clear();

    final result = [["20200102",3066.34,3085.2,3098.1,3066.34,29247020800,1.15],
    ["20200103",3089.02,3083.79,3093.82,3074.52,26149666700,-0.05],
    ["20200106",3070.91,3083.41,3107.2,3065.31,31257584200,-0.01],
    ["20200107",3085.49,3104.8,3105.45,3084.33,27658311100,0.69],
    ["20200108",3094.24,3066.89,3094.24,3059.13,29787255300,-1.22],
    ["20200109",3082.64,3094.88,3097.33,3080.13,24343564900,0.91],
    ["20200110",3102.29,3092.29,3105.22,3081.4,21044246200,-0.08],
    ["20200113",3091.49,3115.57,3115.57,3075.38,21062100400,0.75],
    ["20200114",3120.67,3106.82,3127.17,3105.6,22997376900,-0.28],
    ["20200115",3103.17,3090.04,3107.94,3082.04,20231302300,-0.54],
    ["20200116",3095.73,3074.08,3096.37,3070.88,20337547500,-0.52],
    ["20200117",3081.46,3075.5,3091.95,3067.25,19030429900,0.05],
    ["20200120",3082.11,3095.79,3096.31,3070.48,21049334100,0.66],
    ["20200121",3085.79,3052.14,3085.79,3051.23,23483073900,-1.41],
    ["20200122",3038.49,3060.75,3069.25,3006.27,22385286500,0.28],
    ["20200123",3037.95,2976.53,3045.04,2955.35,27276323400,-2.75],
    ["20200203",2716.7,2746.61,2766.58,2716.7,21591210300,-7.72],
    ["20200204",2685.27,2783.29,2786.16,2685.27,36404620000,1.34],
    ["20200205",2792.37,2818.09,2842.74,2778.86,30976182300,1.25],
    ["20200206",2826.89,2866.51,2876.59,2807.61,31639214200,1.72],
    ["20200207",2858.93,2875.96,2875.96,2838.77,30947964200,0.33],
    ["20200210",2860.5,2890.49,2891.85,2851.05,29492978400,0.51],
    ["20200211",2894.54,2901.67,2913.82,2882.24,26916833500,0.39],
    ["20200212",2895.56,2926.9,2926.9,2892.42,24873342900,0.87],
    ["20200213",2927.14,2906.07,2935.41,2901.24,27480484400,-0.71],
    ["20200214",2899.87,2917.01,2926.94,2899.57,25065062700,0.38],
    ["20200217",2924.99,2983.62,2983.64,2924.99,31319800700,2.28],
    ["20200218",2981.41,2984.97,2990.6,2960.78,31166591300,0.05],
    ["20200219",2979.52,2975.4,2998.27,2971.82,31514115100,-0.32],
    ["20200220",2981.88,3030.15,3031.37,2968.45,34573288100,1.84],
    ["20200221",3022.25,3039.67,3058.9,3020.14,36455727600,0.31],
    ["20200224",3027.89,3031.23,3042.18,3007.36,37043004400,-0.28],
    ["20200225",2982.07,3013.05,3016.95,2943.72,44162276200,-0.6],
    ["20200226",2978.42,2987.93,3028.78,2974.94,46904955200,-0.83],
    ["20200227",2992.49,2991.33,3009.46,2980.48,35052365800,0.11],
    ["20200228",2924.64,2880.3,2948.13,2878.54,40121691400,-3.71],
    ["20200302",2899.31,2970.93,2982.51,2899.31,36733336900,3.15],
    ["20200303",3006.89,2992.9,3026.84,2976.62,41010804700,0.74],
    ["20200304",2981.81,3011.67,3012.0,2974.36,35333827800,0.63],
    ["20200305",3036.15,3071.68,3074.26,3022.93,44542580600,1.99],
    ["20200306",3039.94,3034.51,3052.44,3029.46,36206153300,-1.21],
    ["20200309",2987.18,2943.29,2989.21,2940.71,41456073600,-3.01],
    ["20200310",2918.93,2996.76,3000.3,2904.8,39329664800,1.82],
    ["20200311",3001.76,2968.52,3010.03,2968.52,35247097000,-0.94],
    ["20200312",2936.02,2923.49,2944.47,2906.28,30777845700,-1.52],
    ["20200313",2804.23,2887.43,2910.88,2799.98,36645043600,-1.23],
    ["20200316",2897.3,2789.25,2898.03,2784.66,35187866500,-3.4],
    ["20200317",2796.28,2779.64,2826.91,2715.22,30614967700,-0.34],
    ["20200318",2792.32,2728.76,2815.87,2728.76,29115985200,-1.83],
    ["20200319",2719.41,2702.13,2736.82,2646.8,30230274700,-0.98],
    ["20200320",2727.02,2745.62,2751.9,2702.49,25201950700,1.61],
    ["20200323",2677.59,2660.17,2703.33,2656.5,24982025000,-3.11],
    ["20200324",2703.02,2722.44,2723.41,2667.13,25702193000,2.34],
    ["20200325",2775.3,2781.59,2788.64,2757.8,27314446600,2.17],
    ["20200326",2761.9,2764.91,2788.5,2753.43,23408402200,-0.6],
    ["20200327",2792.98,2772.2,2805.55,2771.76,24076406600,0.26],
    ["20200330",2739.72,2747.21,2759.1,2723.05,23970660400,-0.9],
    ["20200331",2767.31,2750.3,2771.17,2743.12,21859867400,0.11],
    ["20200401",2743.54,2734.52,2773.36,2731.08,21725342700,-0.57],
    ["20200402",2720.23,2780.64,2780.64,2719.9,21786460000,1.69],
    ["20200403",2773.58,2763.99,2780.59,2754.07,20083740400,-0.6],
    ["20200407",2806.97,2820.76,2823.28,2801.84,27019818600,2.05],
    ["20200408",2805.92,2815.37,2823.21,2800.3,24351530500,-0.19],
    ["20200409",2825.84,2825.9,2832.39,2820.43,23818484300,0.37],
    ["20200410",2827.19,2796.63,2833.01,2789.98,23345476800,-1.04],
    ["20200413",2784.6,2783.05,2792.89,2774.08,17712455400,-0.49],
    ["20200414",2794.8,2827.28,2827.3,2789.43,20269656900,1.59],
    ["20200415",2826.66,2811.17,2829.75,2808.7,20562114600,-0.57],
    ["20200416",2798.43,2819.93,2823.34,2796.84,20300377300,0.31],
    ["20200417",2835.56,2838.49,2854.96,2830.02,24573675000,0.66],
    ["20200420",2840.41,2852.55,2852.99,2833.26,21184707800,0.5],
    ["20200421",2842.24,2827.01,2842.24,2808.02,23323587000,-0.9],
    ["20200422",2814.07,2843.98,2843.98,2808.48,21732000000,0.6],
    ["20200423",2850.51,2838.5,2853.64,2835.9,24877903700,-0.19],
    ["20200424",2834.94,2808.53,2834.94,2802.5,23518507600,-1.06],
    ["20200427",2812.24,2815.49,2832.67,2802.96,21013098100,0.25],
    ["20200428",2819.99,2810.02,2821.74,2758.25,25387274500,-0.19],
    ["20200429",2801.38,2822.44,2831.76,2800.74,20206180700,0.44],
    ["20200430",2832.38,2860.08,2865.59,2832.38,24245527800,1.33],
    ["20200506",2831.63,2878.14,2879.26,2830.65,24982661600,0.63],
    ["20200507",2876.47,2871.52,2882.02,2864.58,22673695700,-0.23],
    ["20200508",2882.71,2895.34,2903.8,2879.2,22682207500,0.83],
    ["20200511",2901.57,2894.8,2914.28,2884.38,22512041000,-0.02],
    ["20200512",2894.62,2891.56,2897.9,2871.23,19708298500,-0.11],
    ["20200513",2882.96,2898.05,2900.26,2875.54,18506131000,0.22],
    ["20200514",2887.06,2870.34,2887.06,2869.18,19777620200,-0.96],
    ["20200515",2880.71,2868.46,2884.22,2863.37,18898359200,-0.07]];

    for(var i = 0 ; i < result.length;i++){
      final item = result[i];
      final KLineModel model =   KLineModel(time: item[0],open:item[1] ,close: item[2],top: item[3],bottom: item[4],vol: double.parse(item[5]) / 100000000 );

       dataList.add(model);
    }
    manager.completionAVG();
    manager.completionLastClose();
    manager.completionUpDown();
    return 'true';
  }
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        // Here we take the value from the MyHomePage object that was created by
        // the App.build method, and use it to set our appbar title.
        title: Text(title),
      ),
//backgroundColor: Colors.black,
      body:  FutureBuilder(
        future:getDataList(),
        builder: (BuildContext context,AsyncSnapshot snapshot){
          if(snapshot.hasData){

            return Container(
              width: MediaQuery.of(context).size.width,
              height: MediaQuery.of(context).size.height,
              child:KLineWidget(drawRect:Rect.fromLTWH(50, 10, MediaQuery.of(context).size.width - 50 > 0?MediaQuery.of(context).size.width - 50 :0, MediaQuery.of(context).size.height - 400>0?MediaQuery.of(context).size.height - 400:0)  ,
                dataManager:manager,
                colorConfig: new KLineColorConfig(),
                onLeftScrollEnd: (){

                },
                onRightScrollEnd: (){
                  //右拉刷新

                }, ),
            );
          }else{
            return Center(
              child: Text("加载中..."),
            );
          }
        },
      ) ,floatingActionButton: FloatingActionButton(
      onPressed: _incrementCounter,
      tooltip: 'Increment',
       child: Icon(Icons.add),
    ),
      // This trailing comma makes auto-formatting nicer for build methods.
    );
  }
}
